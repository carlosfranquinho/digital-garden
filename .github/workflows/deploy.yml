name: Process and Deploy Digital Garden

on:
  repository_dispatch:
    types: [obsidian-update]

jobs:
  process-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üöÄ Checkout repo
        uses: actions/checkout@v4

      - name: üì• Process payload
        id: payload
        run: |
          # Converter payload para JSON
          echo '${{ toJSON(github.event.client_payload.notas) }}' > notas.json
          echo "üìã Payload recebido:"
          cat notas.json

      - name: üßπ Limpar diret√≥rios
        run: |
          rm -rf content/posts/*
          rm -rf static/images/*
          mkdir -p content/posts
          mkdir -p static/images

      - name: üìÇ Processar arquivos
        env:
          FILES: ${{ steps.payload.outputs.files }}
        run: |
          # Clonar reposit√≥rio fonte
          git clone https://${{ github.actor }}:${{ secrets.GARDEN_TOKEN }}@github.com/${{ github.repository_owner }}/obsidian-vault.git /tmp/obsidian-vault

          # Slugify function
          slugify() {
            echo "$1" | 
            iconv -t ascii//TRANSLIT |
            tr -d "'" |
            tr -s '[:space:][:punct:]' '-' |
            tr '[:upper:]' '[:lower:]' |
            sed 's/-$//;s/^-//'
          }

          # Processar cada arquivo
          jq -r '.[]' notas.json | while read -r original; do
            if [[ "$original" == *.md ]]; then
              # Slugificar nome do arquivo
              filename=$(basename "$original" .md)
              dirpath=$(dirname "$original")
              slug=$(slugify "$filename")
              new_path="content/posts/$(slugify "$dirpath")/${slug}.md"
              
              # Criar diret√≥rio e copiar arquivo
              mkdir -p "$(dirname "$new_path")"
              cp "/tmp/obsidian-vault/$original" "$new_path"
              
              # Atualizar links de imagens no markdown
              sed -i -E "s|!\[\[attachments/([^]]+)\]\]|![](/images/\1)|g" "$new_path"
              echo "üìÑ Processado: $original ‚Üí $new_path"

            elif [[ "$original" == attachments/* ]]; then
              # Copiar imagens mantendo nome original (ou slugificar se preferir)
              filename=$(basename "$original")
              cp "/tmp/obsidian-vault/$original" "static/images/$filename"
              echo "üñºÔ∏è Copiada imagem: $filename"
            fi
          done

      # [Mant√©m os passos do Hugo e FTP abaixo]
      - name: üõ†Ô∏è Instalar Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: üì¶ Gerar site com Hugo
        run: hugo --minify

      - name: üì° Fazer deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          server-dir: ${{ secrets.FTP_PATH }}
          local-dir: public/
