name: Process and Deploy Digital Garden

on:
  repository_dispatch:
    types: [obsidian-update]

jobs:
  process-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸš€ Checkout Digital Garden
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GARDEN_TOKEN }}

      - name: ğŸ“… Receber ConteÃºdo
        id: payload
        run: |
          echo '${{ toJSON(github.event.client_payload.notas) }}' > /tmp/notas.json
          echo "ğŸ“Œ ConteÃºdo recebido:"
          cat /tmp/notas.json

      - name: ğŸ§¹ Limpar DiretÃ³rios
        run: |
          rm -rf content/notas/*
          mkdir -p content/notas

      - name: ğŸ“‚ Importar Notas e Imagens (modo page bundle)
        run: |
          sudo apt update && sudo apt install -y python3-pip
          pip install pillow python-slugify

          cat << 'EOF' > processar.py
          [o conteÃºdo do teu script Python mantÃ©m-se igual]
          EOF

          git clone https://${{ github.actor }}:${{ secrets.GARDEN_TOKEN }}@github.com/${{ github.repository_owner }}/obsidian-vault.git /tmp/obsidian-vault
          python3 processar.py

      - name: ğŸ› ï¸ Instalar Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      - name: ğŸ“¦ Gerar Site
        run: hugo --minify -d docs

      - name: ğŸ”„ Commitar MudanÃ§as
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add content/notas docs
          git diff --quiet && git diff --staged --quiet || git commit -m "AtualizaÃ§Ã£o automÃ¡tica: conteÃºdo do Obsidian [skip ci]"
          git push
